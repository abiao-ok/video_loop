# video_loop

rtl文件内含有紫光的IP，运行在PDS2022.1版本下。  
本项目基于紫光PGL50H开发板，实现四路视频（HDMI，双摄像头，UDP）输入、拼接、AI识别并显示。

# 一、项目介绍

## 1.1、项目框图实现如下：  

![Alt Text](/image/项目框图.jpg)

## 1.2、双线性差值优化实现

  __根据项目实际情况，优化去除了除法器__  
  __权衡了面积和性能，牺牲了小部分的图片质量（肉眼难以分辨差异），换取了乘法器面积的缩减__

双线性差值的缩放原理坐标图如下：  

![Alt Text](/image/双线性差值缩放坐标图.jpg)

双线性差值计算公式如下，像素点为RGB565：

    f(x,y) = f(Q11)*dx*dy + f(Q12)*(1-dx)*dy + f(Q21)*dx*(1-dy) + f(Q22)*(1-dx)*(1-dy) = f(Q11) + (f(Q12)-f(Q11))*dx + (f(Q21)-f(Q11))*dy  + ((f(Q22)+f(Q11))-(f(Q21)+f(Q12)))*dx*dy


### 1.2.1 对差值系数计算方案和位宽的考虑

求系数公式如下：

![Alt Text](/image/双线性差值算法求系数公式.jpg)
    
观察系数公式，因视频的输入输出尺寸固定，缩放比例固定，由此可知这是一个 __除以常数的除法器__。常规处理方案有：1、 把除数转化为小数，采用乘法运算。2、使用公式转换为乘法。  
但是根据项目实际情况分析：缩放比例固定（1280/960），带入公式可得：__SrcX=(32*DstX+7)/18__。同时，DstX取值范围不变且有规律：0 ~ 959，可推测除以固定常数时，结果也必然具有一定规律：
使用MATLAB计算，截取部分结果如下：  
    
    0.3888	2.1666	3.9444	5.7222	7.5000	9.2777	11.0555	    12.8333	14.6111	
    
    16.3888	18.1666	19.9444	21.7222	23.5000	25.2777	27.05555	28.8333	30.6111
    
注：整数部分代表原像素点坐标；小数部分代表插值系数。  

#### 1.2.1.1 不使用除法器  

规律：原像素点横坐标每16个点一个循环，一个循环固定9个位置的像素点作为顶点参与插值计算，插值系数也有规律。  
__根据规律使用查找表直接获得差值系数，不使用除法器。__
    
#### 1.2.1.2 插值系数位宽  
同时，使用MATLAB计算比较不同精度的小数位，像素值的精度高低，发现二进制下，__保留5bit的插值系数__ 对最终计算得到的像素点整数部分仅影响最低位。此时，根据双线性差值计算公式，乘法器的最大位宽为: __10bit*7bit__  
而退一步，__使用4bit的插值系数__，对像素点整数部分的影响 __绝大部分集中在低3位__，这样的精度误差肉眼也很难察觉，而乘法器的最大位宽降为 __8bit*7bit__。  
__权衡面积与性能后选择使用：4bit的插值系数。__

### 1.2.2 对乘法器计算方案的考虑
    
1、输入的位宽较低且为无符号数运算，两个乘数都较为简单。  
2、有不同位宽乘法器连续并行执行的需求。  
3、紫光PGL50H器件具有现成的LUT8和LUT6硬件资源。  
采用LUT8和LUT6搭建4X4，4X3和4X2的乘法器单元，通过加法器级联形成4X6，4X5，8X7和8X6的乘法器，实现双线性差值算法。  

    
## 1.3、简易DMA模块实现  

DDR3数据对接模块结构图：  

![Alt Text](/image/数据写入DD3前进行缓存的对接.jpg)  
    

像素数据位宽24bit，DDR3数据位宽256bit，并且使用时钟也不相同。使用异步的FIFO缓存数据并转换位宽。为了节约块状RAM（DRAM）资源，并优化功耗。采用：块状FIFO + 分布式FIFO 的结构：  

1、块状FIFO：数据位宽24bit，深度：256/512。仅需1或2个DRAM9K，作用是缓存像素数据，异步FIFO转换时钟域。  

2、分布式FIFO：数据位宽256bit，深度：16。仅使用少量查找表+寄存器资源，把数据位宽转换为DDR3需要的数据位宽，作用是：避免使用多个并行的DRAM组成256bit数据，减少功耗和DRAM用量。  


## 1.4、四路视频输入控制

输入输出接口的配置：UDP通信，双摄像头输入控制，调用HDMI_ip；

![Alt Text](/image/网口控制器.jpg)
  



# 二、实现效果如下：  

## 2.1、视频拼接效果如下  

![Alt Text](/image/视频拼接效果图.jpg)

## 2.2、AI识别效果如下：

![Alt Text](/image/AI识别效果.jpg)
